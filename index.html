<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grocery Receipt Scanner</title>
    
    <!-- Load React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Load Babel to transform JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Load Recharts for charts -->
    <script src="https://unpkg.com/recharts@2.5.0/dist/Recharts.js"></script>
    
    <!-- Load Google API Client Library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- Load Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
        }
        #root {
            width: 100%;
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Check if Recharts loaded
        let BarChart, Bar, PieChart, Pie, Cell, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer;
        
        if (typeof Recharts !== 'undefined') {
          ({ BarChart, Bar, PieChart, Pie, Cell, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts);
        } else {
          console.warn('Recharts not loaded - charts will not display');
          const DummyChart = () => React.createElement('div', {
            style: { padding: '2rem', background: '#fee', borderRadius: '12px', textAlign: 'center' }
          }, 'Charts loading... Please refresh if this persists.');
          BarChart = Bar = PieChart = Pie = Cell = LineChart = Line = XAxis = YAxis = CartesianGrid = Tooltip = Legend = ResponsiveContainer = DummyChart;
        }

        // ==================== CONFIGURATION ====================
        const CONFIG = {
          WORKER_URL: "https://yellow-bonus-b680.brweiss-123.workers.dev/", // e.g., https://receipt-scanner.yourname.workers.dev
          SHEET_ID: "1PJBkbspO1wt_87RQF67VweCearDvb6ONVDIF8713o-g",
          SHEET_NAME_DATA: "Data",
          SHEET_NAME_FEEDBACK: "Feedback_Log",
          GOOGLE_CLIENT_ID: "905686065745-h4dbs7ns8tq898dq0hv1p0hjh216t34c.apps.googleusercontent.com",
          SCOPES: "https://www.googleapis.com/auth/spreadsheets"
        };
        // ======================================================

        // Simple icon components
        const Icon = ({ children, size = 20 }) => (
          <span style={{ fontSize: `${size}px`, lineHeight: 1, display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }}>
            {children}
          </span>
        );

        const Upload = ({ size }) => <Icon size={size}>‚¨ÜÔ∏è</Icon>;
        const Camera = ({ size }) => <Icon size={size}>üì∑</Icon>;
        const BarChart3 = ({ size }) => <Icon size={size}>üìä</Icon>;
        const Tag = ({ size }) => <Icon size={size}>üè∑Ô∏è</Icon>;
        const Sync = ({ size }) => <Icon size={size}>üîÑ</Icon>;
        const Check = ({ size }) => <Icon size={size}>‚úÖ</Icon>;
        const X = ({ size }) => <Icon size={size}>‚ùå</Icon>;
        const Edit = ({ size }) => <Icon size={size}>‚úèÔ∏è</Icon>;
        const Trash = ({ size }) => <Icon size={size}>üóëÔ∏è</Icon>;
        const Plus = ({ size }) => <Icon size={size}>‚ûï</Icon>;
        const Key = ({ size }) => <Icon size={size}>üîë</Icon>;

        // Category definitions
        const categories = {
          'Produce': { color: '#10b981', icon: 'ü•¨' },
          'Dairy': { color: '#3b82f6', icon: 'ü•õ' },
          'Meat': { color: '#ef4444', icon: 'ü•©' },
          'Bakery': { color: '#f59e0b', icon: 'üçû' },
          'Pantry': { color: '#8b5cf6', icon: 'ü•´' },
          'Snacks': { color: '#ec4899', icon: 'üçø' },
          'Beverages': { color: '#06b6d4', icon: 'ü•§' },
          'Frozen': { color: '#6366f1', icon: 'üßä' },
          'Other': { color: '#64748b', icon: 'üõí' }
        };

        const GroceryScanner = () => {
          // State management
          const [view, setView] = useState('dashboard');
          const [isProcessing, setIsProcessing] = useState(false);
          const [isSyncing, setIsSyncing] = useState(false);
          const [isAuthorized, setIsAuthorized] = useState(false);
          const [tokenClient, setTokenClient] = useState(null);
          const [accessToken, setAccessToken] = useState(null);
          
          // Validation state
          const [validationData, setValidationData] = useState(null);
          const [receiptImage, setReceiptImage] = useState(null);
          const [feedback, setFeedback] = useState('');
          
          // Data from Google Sheets
          const [sheetData, setSheetData] = useState([]);
          const [lastSync, setLastSync] = useState(null);

          // Initialize Google API
          useEffect(() => {
            const initializeGoogleAPI = () => {
              // Check if user already has a token
              const savedToken = localStorage.getItem('google_access_token');
              if (savedToken) {
                setAccessToken(savedToken);
                setIsAuthorized(true);
                loadFromSheet(savedToken);
              }

              // Initialize token client
              if (window.google) {
                const client = window.google.accounts.oauth2.initTokenClient({
                  client_id: CONFIG.GOOGLE_CLIENT_ID,
                  scope: CONFIG.SCOPES,
                  callback: (response) => {
                    if (response.access_token) {
                      setAccessToken(response.access_token);
                      setIsAuthorized(true);
                      localStorage.setItem('google_access_token', response.access_token);
                      loadFromSheet(response.access_token);
                    }
                  },
                });
                setTokenClient(client);
              }
            };

            // Wait for Google API to load
            const checkGoogleLoaded = setInterval(() => {
              if (window.google) {
                clearInterval(checkGoogleLoaded);
                initializeGoogleAPI();
              }
            }, 100);

            return () => clearInterval(checkGoogleLoaded);
          }, []);

          // ==================== GOOGLE OAUTH FUNCTIONS ====================
          
          const handleAuthorize = () => {
            if (tokenClient) {
              tokenClient.requestAccessToken();
            } else {
              alert('Google API not loaded yet. Please refresh the page.');
            }
          };

          const handleSignOut = () => {
            setAccessToken(null);
            setIsAuthorized(false);
            localStorage.removeItem('google_access_token');
            setSheetData([]);
          };

          // ==================== GOOGLE SHEETS API FUNCTIONS ====================
          
          const loadFromSheet = async (token = accessToken) => {
            if (!token) {
              console.log('No access token, skipping load');
              return;
            }

            setIsSyncing(true);
            try {
              const response = await fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${CONFIG.SHEET_NAME_DATA}!A2:G`,
                {
                  headers: {
                    'Authorization': `Bearer ${token}`
                  }
                }
              );

              if (!response.ok) {
                if (response.status === 401) {
                  // Token expired
                  handleSignOut();
                  alert('Session expired. Please sign in again.');
                  return;
                }
                throw new Error(`Failed to load data: ${response.statusText}`);
              }

              const data = await response.json();
              const rows = data.values || [];
              
              const parsedData = rows.map(row => ({
                date: row[0] || '',
                store: row[1] || '',
                name: row[2] || '',
                category: row[3] || 'Other',
                price: parseFloat(row[4]) || 0,
                receiptId: row[5] || '',
                uploadTimestamp: row[6] || ''
              }));
              
              setSheetData(parsedData);
              setLastSync(new Date());
              console.log('Loaded', parsedData.length, 'items from Google Sheets');
            } catch (error) {
              console.error('Error loading from sheet:', error);
              alert(`Failed to load data: ${error.message}`);
            } finally {
              setIsSyncing(false);
            }
          };

          const saveToSheet = async () => {
            if (!validationData || !accessToken) return;
            
            setIsProcessing(true);
            
            try {
              const receiptId = Date.now().toString();
              const timestamp = new Date().toISOString();
              
              // Prepare rows for Data sheet
              const dataRows = validationData.items.map(item => [
                item.date,
                validationData.store,
                item.name,
                item.category,
                item.price,
                receiptId,
                timestamp
              ]);
              
              // Append to Data sheet
              const dataResponse = await fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${CONFIG.SHEET_NAME_DATA}!A:G:append?valueInputOption=USER_ENTERED`,
                {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    values: dataRows
                  })
                }
              );

              if (!dataResponse.ok) {
                throw new Error('Failed to save data to sheet');
              }
              
              // Save feedback if provided
              if (feedback.trim()) {
                const feedbackRow = [[
                  receiptId,
                  timestamp,
                  validationData.store,
                  validationData.items.length,
                  feedback,
                  'FALSE'
                ]];
                
                await fetch(
                  `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${CONFIG.SHEET_NAME_FEEDBACK}!A:F:append?valueInputOption=USER_ENTERED`,
                  {
                    method: 'POST',
                    headers: {
                      'Authorization': `Bearer ${accessToken}`,
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                      values: feedbackRow
                    })
                  }
                );
              }
              
              alert(`‚úÖ Successfully saved ${validationData.items.length} items to Google Sheets!`);
              
              // Clear validation state
              setValidationData(null);
              setReceiptImage(null);
              setFeedback('');
              setView('dashboard');
              
              // Reload data
              await loadFromSheet();
              
            } catch (error) {
              console.error('Error saving to sheet:', error);
              alert(`Failed to save: ${error.message}`);
            } finally {
              setIsProcessing(false);
            }
          };

          // ==================== RECEIPT PROCESSING ====================
          
          const processReceiptImages = async (files) => {
            if (CONFIG.WORKER_URL === "YOUR_CLOUDFLARE_WORKER_URL_HERE") {
              alert('Please configure your Cloudflare Worker URL in the code!');
              return;
            }
            
            setIsProcessing(true);
            
            try {
              const file = files[0];
              
              // Convert to base64
              const base64Data = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
              });
              
              // Save image for preview
              const reader2 = new FileReader();
              reader2.onload = () => setReceiptImage(reader2.result);
              reader2.readAsDataURL(file);
              
              // Call Cloudflare Worker
              const response = await fetch(CONFIG.WORKER_URL, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  image_data: base64Data,
                  image_type: file.type
                })
              });
              
              if (!response.ok) {
                throw new Error('Failed to process receipt');
              }
              
              const data = await response.json();
              const text = data.content.map(item => item.text || "").join("\n");
              const cleanText = text.replace(/```json|```/g, "").trim();
              const extractedData = JSON.parse(cleanText);
              
              setValidationData(extractedData);
              setView('validation');
              
            } catch (error) {
              console.error('Error processing receipt:', error);
              alert(`Failed to process receipt: ${error.message}`);
            } finally {
              setIsProcessing(false);
            }
          };

          const handleFileUpload = (event) => {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
              processReceiptImages(files);
            }
          };

          // ==================== VALIDATION FUNCTIONS ====================
          
          const updateValidationItem = (index, field, value) => {
            const updated = { ...validationData };
            updated.items[index][field] = field === 'price' ? parseFloat(value) : value;
            setValidationData(updated);
          };

          const deleteValidationItem = (index) => {
            const updated = { ...validationData };
            updated.items.splice(index, 1);
            setValidationData(updated);
          };

          const addValidationItem = () => {
            const updated = { ...validationData };
            updated.items.push({
              name: '',
              category: 'Other',
              price: 0,
              date: validationData.date
            });
            setValidationData(updated);
          };

          // ==================== DASHBOARD CALCULATIONS ====================
          
          const totalSpent = sheetData.reduce((sum, item) => sum + item.price, 0);
          
          const categoryTotals = sheetData.reduce((acc, item) => {
            acc[item.category] = (acc[item.category] || 0) + item.price;
            return acc;
          }, {});

          const categoryData = Object.entries(categoryTotals).map(([name, value]) => ({
            name,
            value: parseFloat(value.toFixed(2)),
            color: categories[name]?.color || '#64748b'
          }));

          const storeTotals = sheetData.reduce((acc, item) => {
            acc[item.store] = (acc[item.store] || 0) + item.price;
            return acc;
          }, {});

          const storeChartData = Object.entries(storeTotals).map(([name, value]) => ({
            name,
            amount: parseFloat(value.toFixed(2))
          }));

          // ==================== RENDER ====================
          
          return (
            <div style={{
              minHeight: '100vh',
              background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
              fontFamily: '"Plus Jakarta Sans", system-ui, sans-serif',
              padding: '2rem'
            }}>
              <div style={{ maxWidth: '1400px', margin: '0 auto' }}>
                
                {/* Header */}
                <div style={{
                  background: 'rgba(255, 255, 255, 0.95)',
                  borderRadius: '24px',
                  padding: '2rem',
                  marginBottom: '2rem',
                  boxShadow: '0 20px 60px rgba(0, 0, 0, 0.15)'
                }}>
                  <div style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    flexWrap: 'wrap',
                    gap: '1.5rem'
                  }}>
                    <div>
                      <h1 style={{
                        fontSize: '2.5rem',
                        fontWeight: '800',
                        background: 'linear-gradient(135deg, #667eea, #764ba2)',
                        WebkitBackgroundClip: 'text',
                        WebkitTextFillColor: 'transparent',
                        margin: '0 0 0.5rem 0'
                      }}>
                        Receipt Scanner
                      </h1>
                      <p style={{
                        margin: 0,
                        color: '#64748b',
                        fontSize: '1rem'
                      }}>
                        {isAuthorized ? (
                          <>‚úÖ Connected to Google Sheets</>
                        ) : (
                          <>üîí Sign in to get started</>
                        )}
                      </p>
                    </div>
                    
                    <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap' }}>
                      {!isAuthorized ? (
                        <button
                          onClick={handleAuthorize}
                          style={{
                            background: 'linear-gradient(135deg, #4285f4, #34a853)',
                            color: 'white',
                            padding: '0.875rem 1.75rem',
                            borderRadius: '12px',
                            cursor: 'pointer',
                            fontWeight: '600',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.5rem',
                            border: 'none',
                            fontSize: '0.95rem',
                            boxShadow: '0 4px 12px rgba(66, 133, 244, 0.3)'
                          }}
                        >
                          <Key size={20} />
                          Sign in with Google
                        </button>
                      ) : (
                        <>
                          <label style={{
                            background: isProcessing ? '#94a3b8' : 'linear-gradient(135deg, #667eea, #764ba2)',
                            color: 'white',
                            padding: '0.875rem 1.75rem',
                            borderRadius: '12px',
                            cursor: isProcessing ? 'not-allowed' : 'pointer',
                            fontWeight: '600',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.5rem',
                            border: 'none',
                            fontSize: '0.95rem',
                            boxShadow: '0 4px 12px rgba(102, 126, 234, 0.3)'
                          }}>
                            <Upload size={20} />
                            {isProcessing ? 'Processing...' : 'Upload Receipt'}
                            <input
                              type="file"
                              accept="image/*"
                              multiple
                              onChange={handleFileUpload}
                              disabled={isProcessing}
                              style={{ display: 'none' }}
                            />
                          </label>
                          
                          <button
                            onClick={() => loadFromSheet()}
                            disabled={isSyncing}
                            style={{
                              background: 'white',
                              color: '#667eea',
                              border: '2px solid #667eea',
                              padding: '0.875rem 1.75rem',
                              borderRadius: '12px',
                              cursor: isSyncing ? 'not-allowed' : 'pointer',
                              fontWeight: '600',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '0.5rem',
                              fontSize: '0.95rem'
                            }}
                          >
                            <Sync size={20} />
                            {isSyncing ? 'Syncing...' : 'Sync'}
                          </button>
                          
                          <button
                            onClick={handleSignOut}
                            style={{
                              background: 'white',
                              color: '#64748b',
                              border: '2px solid #e2e8f0',
                              padding: '0.875rem 1.75rem',
                              borderRadius: '12px',
                              cursor: 'pointer',
                              fontWeight: '600',
                              fontSize: '0.95rem'
                            }}
                          >
                            Sign Out
                          </button>
                        </>
                      )}
                    </div>
                  </div>
                  
                  {lastSync && (
                    <div style={{
                      marginTop: '1rem',
                      fontSize: '0.875rem',
                      color: '#64748b'
                    }}>
                      Last synced: {lastSync.toLocaleTimeString()}
                    </div>
                  )}
                </div>

                {/* Show sign-in prompt if not authorized */}
                {!isAuthorized && view !== 'validation' && (
                  <div style={{
                    background: 'white',
                    borderRadius: '20px',
                    padding: '4rem 2rem',
                    textAlign: 'center',
                    boxShadow: '0 8px 24px rgba(0, 0, 0, 0.1)'
                  }}>
                    <Key size={64} style={{ color: '#cbd5e1', margin: '0 auto 1.5rem' }} />
                    <h3 style={{
                      fontSize: '1.5rem',
                      fontWeight: '700',
                      color: '#334155',
                      marginBottom: '0.5rem'
                    }}>
                      Sign In Required
                    </h3>
                    <p style={{ color: '#64748b', marginBottom: '2rem' }}>
                      Connect to Google Sheets to start scanning receipts
                    </p>
                    <button
                      onClick={handleAuthorize}
                      style={{
                        background: 'linear-gradient(135deg, #4285f4, #34a853)',
                        color: 'white',
                        padding: '1rem 2rem',
                        borderRadius: '12px',
                        cursor: 'pointer',
                        fontWeight: '600',
                        display: 'inline-flex',
                        alignItems: 'center',
                        gap: '0.75rem',
                        border: 'none',
                        fontSize: '1rem',
                        boxShadow: '0 4px 12px rgba(66, 133, 244, 0.3)'
                      }}
                    >
                      <Key size={24} />
                      Sign in with Google
                    </button>
                  </div>
                )}

                {/* Navigation - Only show when authorized and not validating */}
                {isAuthorized && view !== 'validation' && (
                  <div style={{
                    background: 'rgba(255, 255, 255, 0.95)',
                    borderRadius: '16px',
                    padding: '0.5rem',
                    marginBottom: '2rem',
                    display: 'flex',
                    gap: '0.5rem',
                    boxShadow: '0 8px 24px rgba(0, 0, 0, 0.1)'
                  }}>
                    {[
                      { id: 'dashboard', icon: BarChart3, label: 'Dashboard' },
                      { id: 'byitem', icon: Tag, label: 'By Item' }
                    ].map(tab => (
                      <button
                        key={tab.id}
                        onClick={() => setView(tab.id)}
                        style={{
                          flex: 1,
                          padding: '0.875rem',
                          border: 'none',
                          borderRadius: '12px',
                          background: view === tab.id ? 'linear-gradient(135deg, #667eea, #764ba2)' : 'transparent',
                          color: view === tab.id ? 'white' : '#64748b',
                          fontWeight: '600',
                          cursor: 'pointer',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          gap: '0.5rem',
                          transition: 'all 0.3s ease',
                          fontSize: '0.95rem'
                        }}
                      >
                        <tab.icon size={20} />
                        {tab.label}
                      </button>
                    ))}
                  </div>
                )}

                {/* VALIDATION VIEW */}
                {view === 'validation' && validationData && (
                  <div style={{
                    background: 'white',
                    borderRadius: '20px',
                    padding: '2rem',
                    boxShadow: '0 8px 24px rgba(0, 0, 0, 0.1)'
                  }}>
                    <h2 style={{
                      margin: '0 0 1.5rem 0',
                      fontSize: '1.5rem',
                      fontWeight: '700',
                      color: '#334155'
                    }}>Validate Receipt</h2>
                    
                    <div style={{ display: 'flex', gap: '2rem' }}>
                      {/* Left: Receipt Image */}
                      <div style={{ flex: '0 0 40%' }}>
                        {receiptImage && (
                          <img
                            src={receiptImage}
                            alt="Receipt"
                            style={{
                              width: '100%',
                              borderRadius: '12px',
                              boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
                            }}
                          />
                        )}
                      </div>
                      
                      {/* Right: Editable Table + Feedback */}
                      <div style={{ flex: 1 }}>
                        <div style={{
                          background: '#f8fafc',
                          borderRadius: '12px',
                          padding: '1.5rem',
                          marginBottom: '1.5rem'
                        }}>
                          <div style={{ marginBottom: '1rem' }}>
                            <strong>Store:</strong> {validationData.store} ‚Ä¢ <strong>Date:</strong> {validationData.date}
                          </div>
                          
                          <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                              <tr style={{ borderBottom: '2px solid #e2e8f0' }}>
                                <th style={{ padding: '0.5rem', textAlign: 'left', fontSize: '0.875rem' }}>Item</th>
                                <th style={{ padding: '0.5rem', textAlign: 'left', fontSize: '0.875rem' }}>Category</th>
                                <th style={{ padding: '0.5rem', textAlign: 'right', fontSize: '0.875rem' }}>Price</th>
                                <th style={{ padding: '0.5rem', width: '60px' }}></th>
                              </tr>
                            </thead>
                            <tbody>
                              {validationData.items.map((item, idx) => (
                                <tr key={idx} style={{ borderBottom: '1px solid #f1f5f9' }}>
                                  <td style={{ padding: '0.5rem' }}>
                                    <input
                                      type="text"
                                      value={item.name}
                                      onChange={(e) => updateValidationItem(idx, 'name', e.target.value)}
                                      style={{
                                        width: '100%',
                                        padding: '0.5rem',
                                        border: '1px solid #e2e8f0',
                                        borderRadius: '6px',
                                        fontSize: '0.875rem'
                                      }}
                                    />
                                  </td>
                                  <td style={{ padding: '0.5rem' }}>
                                    <select
                                      value={item.category}
                                      onChange={(e) => updateValidationItem(idx, 'category', e.target.value)}
                                      style={{
                                        width: '100%',
                                        padding: '0.5rem',
                                        border: '1px solid #e2e8f0',
                                        borderRadius: '6px',
                                        fontSize: '0.875rem'
                                      }}
                                    >
                                      {Object.keys(categories).map(cat => (
                                        <option key={cat} value={cat}>{categories[cat].icon} {cat}</option>
                                      ))}
                                    </select>
                                  </td>
                                  <td style={{ padding: '0.5rem' }}>
                                    <input
                                      type="number"
                                      step="0.01"
                                      value={item.price}
                                      onChange={(e) => updateValidationItem(idx, 'price', e.target.value)}
                                      style={{
                                        width: '100%',
                                        padding: '0.5rem',
                                        border: '1px solid #e2e8f0',
                                        borderRadius: '6px',
                                        fontSize: '0.875rem',
                                        textAlign: 'right'
                                      }}
                                    />
                                  </td>
                                  <td style={{ padding: '0.5rem', textAlign: 'center' }}>
                                    <button
                                      onClick={() => deleteValidationItem(idx)}
                                      style={{
                                        background: '#fee2e2',
                                        color: '#dc2626',
                                        border: 'none',
                                        borderRadius: '6px',
                                        padding: '0.5rem',
                                        cursor: 'pointer'
                                      }}
                                    >
                                      <Trash size={16} />
                                    </button>
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                          
                          <button
                            onClick={addValidationItem}
                            style={{
                              marginTop: '1rem',
                              background: '#f0fdf4',
                              color: '#16a34a',
                              border: '1px solid #16a34a',
                              padding: '0.5rem 1rem',
                              borderRadius: '8px',
                              cursor: 'pointer',
                              fontWeight: '600',
                              fontSize: '0.875rem',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '0.5rem'
                            }}
                          >
                            <Plus size={16} /> Add Item
                          </button>
                        </div>
                        
                        {/* Feedback Section */}
                        <div style={{
                          background: '#eff6ff',
                          borderRadius: '12px',
                          padding: '1.5rem',
                          marginBottom: '1.5rem'
                        }}>
                          <label style={{
                            display: 'block',
                            fontWeight: '600',
                            color: '#1e40af',
                            marginBottom: '0.75rem',
                            fontSize: '0.95rem'
                          }}>
                            üí¨ Feedback (Optional)
                          </label>
                          <p style={{
                            fontSize: '0.875rem',
                            color: '#3b82f6',
                            marginBottom: '0.75rem'
                          }}>
                            What did the AI get wrong? Your feedback helps improve future extractions.
                          </p>
                          <textarea
                            value={feedback}
                            onChange={(e) => setFeedback(e.target.value)}
                            placeholder="Example: Discount lines were treated as items, or 'eggs' was misread as 'eggz'"
                            style={{
                              width: '100%',
                              minHeight: '80px',
                              padding: '0.75rem',
                              border: '2px solid #dbeafe',
                              borderRadius: '8px',
                              fontSize: '0.875rem',
                              fontFamily: 'inherit',
                              resize: 'vertical'
                            }}
                          />
                        </div>
                        
                        {/* Action Buttons */}
                        <div style={{ display: 'flex', gap: '1rem', justifyContent: 'flex-end' }}>
                          <button
                            onClick={() => {
                              setValidationData(null);
                              setReceiptImage(null);
                              setFeedback('');
                              setView('dashboard');
                            }}
                            style={{
                              background: 'white',
                              color: '#64748b',
                              border: '2px solid #e2e8f0',
                              padding: '0.875rem 1.75rem',
                              borderRadius: '12px',
                              cursor: 'pointer',
                              fontWeight: '600',
                              fontSize: '0.95rem',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '0.5rem'
                            }}
                          >
                            <X size={18} /> Cancel
                          </button>
                          
                          <button
                            onClick={saveToSheet}
                            disabled={isProcessing}
                            style={{
                              background: isProcessing ? '#94a3b8' : 'linear-gradient(135deg, #10b981, #059669)',
                              color: 'white',
                              border: 'none',
                              padding: '0.875rem 2rem',
                              borderRadius: '12px',
                              cursor: isProcessing ? 'not-allowed' : 'pointer',
                              fontWeight: '600',
                              fontSize: '0.95rem',
                              boxShadow: '0 4px 12px rgba(16, 185, 129, 0.3)',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '0.5rem'
                            }}
                          >
                            <Check size={18} /> Save to Google Sheet
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* DASHBOARD VIEW */}
                {isAuthorized && view === 'dashboard' && (
                  <div>
                    {sheetData.length === 0 ? (
                      <div style={{
                        background: 'white',
                        borderRadius: '20px',
                        padding: '4rem 2rem',
                        textAlign: 'center',
                        boxShadow: '0 8px 24px rgba(0, 0, 0, 0.1)'
                      }}>
                        <Camera size={64} style={{ color: '#cbd5e1', margin: '0 auto 1.5rem' }} />
                        <h3 style={{
                          fontSize: '1.5rem',
                          fontWeight: '700',
                          color: '#334155',
                          marginBottom: '0.5rem'
                        }}>
                          No Data Yet
                        </h3>
                        <p style={{ color: '#64748b', marginBottom: '2rem' }}>
                          Upload your first receipt to get started!
                        </p>
                      </div>
                    ) : (
                      <>
                        {/* Summary Cards */}
                        <div style={{
                          display: 'grid',
                          gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))',
                          gap: '1.5rem',
                          marginBottom: '2rem'
                        }}>
                          <div style={{
                            background: 'linear-gradient(135deg, #667eea, #764ba2)',
                            borderRadius: '20px',
                            padding: '2rem',
                            color: 'white',
                            boxShadow: '0 12px 32px rgba(102, 126, 234, 0.3)'
                          }}>
                            <div style={{ fontSize: '0.95rem', opacity: 0.9, marginBottom: '0.5rem' }}>
                              Total Spent
                            </div>
                            <div style={{ fontSize: '2.5rem', fontWeight: '800' }}>
                              ${totalSpent.toFixed(2)}
                            </div>
                            <div style={{ fontSize: '0.875rem', opacity: 0.8, marginTop: '0.5rem' }}>
                              {sheetData.length} items tracked
                            </div>
                          </div>
                        </div>

                        {/* Charts */}
                        <div style={{
                          display: 'grid',
                          gridTemplateColumns: 'repeat(auto-fit, minmax(450px, 1fr))',
                          gap: '2rem'
                        }}>
                          {/* Category Pie Chart */}
                          {categoryData.length > 0 && (
                            <div style={{
                              background: 'white',
                              borderRadius: '20px',
                              padding: '2rem',
                              boxShadow: '0 8px 24px rgba(0, 0, 0, 0.1)'
                            }}>
                              <h3 style={{
                                margin: '0 0 1.5rem 0',
                                fontSize: '1.25rem',
                                fontWeight: '700',
                                color: '#334155'
                              }}>Spending by Category</h3>
                              <ResponsiveContainer width="100%" height={300}>
                                <PieChart>
                                  <Pie
                                    data={categoryData}
                                    cx="50%"
                                    cy="50%"
                                    labelLine={false}
                                    label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                                    outerRadius={100}
                                    dataKey="value"
                                  >
                                    {categoryData.map((entry, index) => (
                                      <Cell key={`cell-${index}`} fill={entry.color} />
                                    ))}
                                  </Pie>
                                  <Tooltip formatter={(value) => `$${value.toFixed(2)}`} />
                                </PieChart>
                              </ResponsiveContainer>
                            </div>
                          )}

                          {/* Store Bar Chart */}
                          {storeChartData.length > 0 && (
                            <div style={{
                              background: 'white',
                              borderRadius: '20px',
                              padding: '2rem',
                              boxShadow: '0 8px 24px rgba(0, 0, 0, 0.1)'
                            }}>
                              <h3 style={{
                                margin: '0 0 1.5rem 0',
                                fontSize: '1.25rem',
                                fontWeight: '700',
                                color: '#334155'
                              }}>Spending by Store</h3>
                              <ResponsiveContainer width="100%" height={300}>
                                <BarChart data={storeChartData}>
                                  <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                                  <XAxis dataKey="name" stroke="#64748b" />
                                  <YAxis stroke="#64748b" />
                                  <Tooltip formatter={(value) => `$${value.toFixed(2)}`} />
                                  <Bar dataKey="amount" fill="url(#colorGradient)" radius={[8, 8, 0, 0]} />
                                  <defs>
                                    <linearGradient id="colorGradient" x1="0" y1="0" x2="0" y2="1">
                                      <stop offset="0%" stopColor="#667eea" stopOpacity={1} />
                                      <stop offset="100%" stopColor="#764ba2" stopOpacity={1} />
                                    </linearGradient>
                                  </defs>
                                </BarChart>
                              </ResponsiveContainer>
                            </div>
                          )}
                        </div>
                      </>
                    )}
                  </div>
                )}

                {/* BY ITEM VIEW */}
                {isAuthorized && view === 'byitem' && (
                  <div style={{
                    background: 'white',
                    borderRadius: '20px',
                    padding: '2rem',
                    boxShadow: '0 8px 24px rgba(0, 0, 0, 0.1)'
                  }}>
                    <h2 style={{
                      margin: '0 0 1.5rem 0',
                      fontSize: '1.5rem',
                      fontWeight: '700',
                      color: '#334155'
                    }}>Spending by Item</h2>
                    
                    {(() => {
                      const grouped = sheetData.reduce((acc, item) => {
                        const key = item.name.toLowerCase().trim();
                        if (!acc[key]) {
                          acc[key] = {
                            name: item.name,
                            category: item.category,
                            totalSpent: 0,
                            count: 0,
                            purchases: []
                          };
                        }
                        acc[key].totalSpent += item.price;
                        acc[key].count += 1;
                        acc[key].purchases.push({
                          date: item.date,
                          store: item.store,
                          price: item.price
                        });
                        return acc;
                      }, {});
                      
                      const groupedArray = Object.values(grouped)
                        .map(item => ({
                          ...item,
                          avgPrice: item.totalSpent / item.count
                        }))
                        .sort((a, b) => b.totalSpent - a.totalSpent);
                      
                      return groupedArray.length > 0 ? (
                        <div style={{ overflowX: 'auto' }}>
                          <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                              <tr style={{ borderBottom: '2px solid #e2e8f0' }}>
                                <th style={{ padding: '1rem', textAlign: 'left', fontWeight: '600', color: '#64748b' }}>Item</th>
                                <th style={{ padding: '1rem', textAlign: 'left', fontWeight: '600', color: '#64748b' }}>Category</th>
                                <th style={{ padding: '1rem', textAlign: 'center', fontWeight: '600', color: '#64748b' }}>Purchases</th>
                                <th style={{ padding: '1rem', textAlign: 'right', fontWeight: '600', color: '#64748b' }}>Total</th>
                                <th style={{ padding: '1rem', textAlign: 'right', fontWeight: '600', color: '#64748b' }}>Avg Price</th>
                              </tr>
                            </thead>
                            <tbody>
                              {groupedArray.map((item, idx) => (
                                <tr key={idx} style={{ borderBottom: '1px solid #f1f5f9' }}>
                                  <td style={{ padding: '1rem', fontWeight: '500', color: '#334155' }}>
                                    {item.name}
                                  </td>
                                  <td style={{ padding: '1rem' }}>
                                    <span style={{
                                      background: `${categories[item.category]?.color}15`,
                                      color: categories[item.category]?.color,
                                      padding: '0.375rem 0.75rem',
                                      borderRadius: '8px',
                                      fontSize: '0.875rem',
                                      fontWeight: '600'
                                    }}>
                                      {categories[item.category]?.icon} {item.category}
                                    </span>
                                  </td>
                                  <td style={{ padding: '1rem', textAlign: 'center', fontWeight: '600', color: '#334155' }}>
                                    {item.count}x
                                  </td>
                                  <td style={{ padding: '1rem', textAlign: 'right', fontWeight: '700', color: '#667eea', fontSize: '1.1rem' }}>
                                    ${item.totalSpent.toFixed(2)}
                                  </td>
                                  <td style={{ padding: '1rem', textAlign: 'right', color: '#64748b' }}>
                                    ${item.avgPrice.toFixed(2)}
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      ) : (
                        <div style={{ textAlign: 'center', padding: '3rem', color: '#64748b' }}>
                          <Tag size={48} style={{ margin: '0 auto 1rem', opacity: 0.3 }} />
                          <p>No items yet. Upload receipts to get started!</p>
                        </div>
                      );
                    })()}
                  </div>
                )}
              </div>
            </div>
          );
        };

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GroceryScanner />);
    </script>
</body>
</html>
